<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Pro Client (Vue 3)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      .message-list {
        scrollbar-width: thin;
        scrollbar-color: #4b5563 #1f2937;
      }
      .connection-status.connected {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(74, 222, 128, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
        }
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
      <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6 text-green-400">
          WebSocket Pro Client (Vue 3)
        </h1>

        <!-- 连接控制 -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg mb-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1"
                >WebSocket URL</label
              >
              <input
                v-model="wsUrl"
                type="text"
                class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm"
              />
            </div>
            <div class="flex items-end space-x-2">
              <button
                @click="connect"
                :disabled="isConnected"
                class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition disabled:opacity-50"
              >
                Connect
              </button>
              <button
                @click="disconnect"
                :disabled="!isConnected"
                class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md transition disabled:opacity-50"
              >
                Disconnect
              </button>
            </div>
            <div
              :class="['p-4 rounded-md', isConnected ? 'bg-green-900/50 connection-status connected' : 'bg-gray-700']"
            >
              <div class="flex items-center">
                <div
                  :class="['w-3 h-3 rounded-full mr-2', isConnected ? 'bg-green-400' : 'bg-gray-400']"
                ></div>
                <span>{{ isConnected ? 'Connected' : 'Disconnected' }}</span>
              </div>
              <div v-if="lastPongTime" class="text-xs mt-2 text-gray-400">
                Last PONG: {{ lastPongTime }}
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- 配置面板 -->
          <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-blue-300">
              Configuration
            </h2>
            <div class="space-y-4">
              <div>
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    v-model="config.isNeedHeartbeat"
                    @change="updateConfig({ isNeedHeartbeat: config.isNeedHeartbeat })"
                    class="mr-2"
                  />
                  Enable Heartbeat
                </label>
              </div>

              <template v-if="config.isNeedHeartbeat">
                <div class="space-y-3 pl-6">
                  <div>
                    <label class="block text-sm font-medium mb-1"
                      >Interval (ms)</label
                    >
                    <input
                      type="number"
                      v-model.number="config.heartbeat.interval"
                      @change="updateHeartbeatConfig"
                      class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-1 text-sm"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1"
                      >Timeout (ms)</label
                    >
                    <input
                      type="number"
                      v-model.number="config.heartbeat.timeout"
                      @change="updateHeartbeatConfig"
                      class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-1 text-sm"
                    />
                  </div>
                </div>
              </template>

              <div>
                <label class="block text-sm font-medium mb-1"
                  >Max Reconnect Attempts</label
                >
                <input
                  type="number"
                  v-model.number="config.maxReconnectAttempts"
                  @change="updateConfig({ maxReconnectAttempts: config.maxReconnectAttempts })"
                  class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-1 text-sm"
                />
              </div>
            </div>
          </div>

          <!-- 消息面板 -->
          <div class="bg-gray-800 rounded-lg p-6 shadow-lg lg:col-span-2">
            <h2 class="text-xl font-semibold mb-4 text-purple-300">
              Messaging
            </h2>
            <div class="mb-4">
              <label class="block text-sm font-medium mb-1">Message</label>
              <div class="flex">
                <input
                  type="text"
                  v-model="message"
                  @keyup.enter="sendMessage"
                  :disabled="!isConnected"
                  class="flex-1 bg-gray-700 border border-gray-600 rounded-l-md px-3 py-2 text-sm disabled:opacity-50"
                  placeholder="Type your message..."
                />
                <button
                  @click="sendMessage"
                  :disabled="!isConnected || !message.trim()"
                  class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-r-md transition disabled:opacity-50"
                >
                  Send
                </button>
              </div>
            </div>

            <div class="h-64 bg-gray-900 rounded-md overflow-hidden">
              <div class="message-list h-full overflow-y-auto p-3 space-y-2">
                <div
                  v-for="(msg, index) in messages"
                  :key="index"
                  :class="{
                  'bg-blue-900/50 text-blue-100': msg.type === 'sent',
                  'bg-green-900/50 text-green-100': msg.type === 'received',
                  'bg-red-900/50 text-red-100': msg.type === 'error',
                  'bg-gray-700/50 text-gray-300': msg.type === 'system'
                }"
                  class="p-2 rounded-md text-sm break-words"
                >
                  {{ msg.text }}
                </div>
                <div
                  v-if="messages.length === 0"
                  class="text-gray-500 text-center mt-20"
                >
                  No messages yet
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 测试按钮 -->
        <div class="mt-6 bg-gray-800 rounded-lg p-6 shadow-lg">
          <h2 class="text-xl font-semibold mb-4 text-yellow-300">
            Quick Tests
          </h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <button
              @click="client?.reconnect()"
              :disabled="!isConnected"
              class="bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-3 rounded-md text-sm transition disabled:opacity-50"
            >
              Force Reconnect
            </button>
            <button
              @click="sendTestMessage"
              :disabled="!isConnected"
              class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-md text-sm transition disabled:opacity-50"
            >
              Send Test Message
            </button>
            <button
              @click="toggleHeartbeat"
              class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-3 rounded-md text-sm transition"
            >
              Toggle Heartbeat
            </button>
            <button
              @click="clearLogs"
              class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-3 rounded-md text-sm transition"
            >
              Clear Logs
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { createWebSocketManager } from "../dist/websocket-pro.es.js";

      const app = Vue.createApp({
        data() {
          return {
            wsUrl: "wss://echo.websocket.org",
            message: "",
            messages: [],
            isConnected: false,
            config: {
              isNeedHeartbeat: true,
              heartbeat: {
                interval: 10000,
                timeout: 5000,
                message: "PING",
              },
              maxReconnectAttempts: 5,
              reconnectDelay: 1000,
            },
            client: null,
            reconnectAttempts: 0,
            lastPongTime: null,
          };
        },
        methods: {
          connect() {
            if (this.client) {
              this.client.close();
            }

            this.client = createWebSocketManager(this.config).connect(
              this.wsUrl
            );
            this.isConnected = false;
            this.addMessage("system", `Connecting to ${this.wsUrl}...`);

            this.client.on("open", () => {
              this.isConnected = true;
              this.addMessage("system", "Connected successfully!");
            });

            this.client.on("message", (data) => {
              if (data === "PONG") {
                this.lastPongTime = new Date().toLocaleTimeString();
                return;
              }
              this.addMessage("received", data);
            });

            this.client.on("close", () => {
              this.isConnected = false;
              this.addMessage("system", "Disconnected");
            });

            this.client.on("error", (err) => {
              this.addMessage("error", `Error: ${err.message || err}`);
            });

            this.client.on("reconnect", (attempt) => {
              this.reconnectAttempts = attempt;
              this.addMessage("system", `Reconnecting (attempt ${attempt})...`);
            });

            this.client.on("timeout", () => {
              this.addMessage("error", "Heartbeat timeout! Reconnecting...");
            });
          },
          disconnect() {
            if (this.client) {
              this.client.close();
              this.client = null;
            }
          },
          sendMessage() {
            if (this.message.trim() && this.client) {
              this.client
                .send(this.message)
                .then(() => {
                  this.addMessage("sent", this.message);
                  this.message = "";
                })
                .catch((err) => {
                  this.addMessage("error", `Failed to send: ${err.message}`);
                });
            }
          },
          sendTestMessage() {
            const testMsg = `Test message ${new Date().toLocaleTimeString()}`;
            this.message = testMsg;
            this.sendMessage();
          },
          addMessage(type, text) {
            this.messages.push({ type, text });
            // 自动滚动到底部
            this.$nextTick(() => {
              const container = document.querySelector(".message-list");
              if (container) container.scrollTop = container.scrollHeight;
            });
          },
          updateConfig(newConfig) {
            const mergedConfig = { ...this.config, ...newConfig };
            this.config = mergedConfig;
            if (this.client) {
              this.client.updateConfig(mergedConfig);
            }
          },
          updateHeartbeatConfig() {
            this.updateConfig({
              heartbeat: this.config.heartbeat,
            });
          },
          toggleHeartbeat() {
            this.config.isNeedHeartbeat = !this.config.isNeedHeartbeat;
            this.updateConfig({ isNeedHeartbeat: this.config.isNeedHeartbeat });
          },
          clearLogs() {
            this.messages = [];
            this.reconnectAttempts = 0;
          },
        },
      });

      app.mount("#app");
    </script>
  </body>
</html>
